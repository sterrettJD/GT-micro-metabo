---
title: "Microbe-metabolite regression analysis"
author: "John Sterrett"
date: '2022-07-14'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

pacman::p_load(tidyverse,
               lme4, lmerTest,
               qiime2R,
               data.table)

'%ni%' <- Negate('%in%')

setwd("/Users/johnsterrett/Research-Projects/Reisdorph/GT-micro-metabo/analysis")


```

# Load data

```{r}
# read in genus level table
genus <- read_qza("../microbiome/L6-collapsed-table.qza")$data %>% as.data.frame()
genus_names <- row.names(genus)

# convert to relative abundance
genus <- sapply(genus,
                prop.table) * 100
genus <- genus %>% as.data.frame(row.names = genus_names)

# check that all colsums are 100
unique(colSums(genus))

genus <- t(genus) %>% as.data.frame()

rownames(genus)


# read in metadata
metadata <- fread("../metadata/mapping.tsv", sep = "\t")
rownames(metadata) <- metadata$`MetaboSampleID`

# read in metabolites
aqueous <- fread("../metabolome/raw_aqueous.tsv",
                 sep="\t", header = T) %>% as.data.frame()
row.names(aqueous) <- aqueous$V1
aqueous$V1 <- NULL

aqueous <- aqueous[rownames(aqueous) %ni% c("Compound Name", "Retention Time",
                                          "Measured Retention Time", "Product Mass",
                                         "QualifierMass", "CASNumber",
                                         "CompoundType", "ISTDCompoundName", 
                                         "Mass Column"),]
aqueous <- mutate_all(aqueous, function(x) as.numeric(as.character(x)))


# read in lipids
lipids <- fread("../metabolome/raw_lipid.tsv",
                sep="\t",
                header = T)

row.names(lipids) <- lipids$V1
lipids$V1 <- NULL

lipids <- lipids[rownames(lipids) %ni% c("Compound Name", "Retention Time",
                                          "Measured Retention Time", "Product Mass",
                                         "QualifierMass", "CASNumber",
                                         "CompoundType", "ISTDCompoundName", 
                                         "Mass Column"),]
lipids <- mutate_all(lipids, function(x) as.numeric(as.character(x)))

# map genus sample ids to metabolomics sample ids
new_genus_sample_ids <- c()
for (x in row.names(genus)){
    sampleid <- metadata[metadata$`#SampleID`==x, "MetaboSampleID"][[1,1]]
    new_genus_sample_ids <- c(new_genus_sample_ids, sampleid)
}

for (i in 1:length(new_genus_sample_ids)){
    print(paste0("Mapping ", rownames(genus)[i], 
                 " to ", new_genus_sample_ids[i]))
}

rownames(genus) <- new_genus_sample_ids
```

# Transform data
```{r}
# hist before transformation
hist(genus[, 1:3])

# arcsinh transform microbiome data
genus <- genus %>% mutate_all(function(x) log(x + sqrt(x^2 + 1)))

# hist after transformation
hist(genus[, 1:3])

```



# Assess sparsity
```{r}
# microbiome
feature_sparsity <- genus %>% sapply(function(x) coop::sparsity(as.matrix(x)))
hist(feature_sparsity, breaks=50)

# aqueous

feature_sparsity <- aqueous %>% sapply(function(x) coop::sparsity(as.matrix(x)))
hist(feature_sparsity, breaks=50)
unique(feature_sparsity)


```